# Spring AOP

Spring AOP 是 Spring 框架体系结构中非常重要的功能模块之一，该模块提供了面向切面编程实现。
面向切面编程在事务处理、日志记录、安全控制等操作中被广泛使用

AOP 面向切面编程，它与 OOP 面向对象编程相辅相成，提供了与 OOP 不同的抽象软件结构的视角，
在 OOP 中，以类作为程序的基本单元，而 AOP 中的基本单元是 Aspect 切面

在业务处理代码中通常有日志记录、性能统计、安全控制、事务处理、异常处理等操作

尽管使用 OOP 可以通过封装或继承的方式达到代码的重用，但仍然有同样的代码分散在各个方法中。
因此，采用 OOP 处理日志记录等操作不仅增加了开发者的工作量，而且提高了升级维护的困难。为了解决
此类问题，AOP 思想应运而生

AOP 采取横向抽取机制，即将分散在各个方法中的重复代码提取出来，然后在程序编译或运行阶段将这些抽取
出来的代码应用到需要执行的地方。这种横向抽取机制采用传统的 OOP 是无法办到的

因为 OOP 实现的是父子关系的纵向重用，但时 AOP 不是 OOP 的替代品，而是 OOP 的补充

## AOP 的术语

- 切面

切面是指封装横切到系统功能的类

- 连接点

连接点是指程序运行中的一些时间点，例如方法的调用或异常的抛出

- 切入点

切入点是指需要处理的连接点，在 Spring AOP 中，所有的方法执行都是连接点，而切入点是一个描述信息，它修饰的是连接
点，通过切入点确定哪些连接点需要被处理

- 通知

通知是由切面添加到特定的连接点的一段代码，即在定义好的切入点处要执行的程序代码，可以理解为切面开启切面的方法，因此
通知是切面的具体实现

- 引入

运入允许在现在的实现类中添加自定义的方法和属性

- 目标对象

目标对象是指所有被通知的对象。如果 AOP 框架使用运行时代理的方式来实现切面，那么通知对象总是一个
代理对象

- 代理

代理是通知应用到目标对象之后被动态创建的对象

- 织入

织入是将切面代码插入到目标对象上，从而生成代理对象的过程。根据不同的实现技术，AOP 织入有 3 种方式，
编译期织入，需要有特殊的 Java 编译器。类装载期织入，需要有特殊的类装载器。动态代理织入，在运行期为
目标类添加通知生成子类的方式

Spring AOP 框架默认采用动态代理织入

## 动态代理

在 Java 中有多种动态代理技术，例如 JDK、CGLIB、Javassist、ASM 其中最常用的动态代理技术是 JDK 和 CGLIB

### JDK 动态代理

JDK 动态代理是`java.lang.reflect.*`包提供的方式，它必须借助一个接口才能产生代理对象。因此，
对于使用业务接口的类，Spring 默认使用 JDK 动态代理实现 AOP

### CGLIB 动态代理

JDK 动态代理必须提供接口才能使用，对于没有提供接口的类，只能采用 CGLIB 动态代理

CGLIB(Code Generation Library)是一个高性能开源的代码生成包，采用非常底层的字节码技术，对指定的
目标类生成一个子类，并对子类进行增强。在 Spring Core 包中已经集成了 CGLIB 所需要的 JAR 包

## 基于代理类的 AOP 实现

在 Spring 中默认使用 JDK 动态代理实现 AOP 编程，使用`org.springframework.aop.framework.ProxyFactoryBean`
创建代理是 Spring AOP 实现的最基本方式

### 通知类型

根据 Spring 中通知在目标类方法中的连接点位置，通知可以分为 6 种类型

- 环绕通知，在目标方法执行前和执行后实施增强，可应用于日志记录、事物处理等

- 前置通知，目标方法执行前实施增加，可应用于权限管理等

- 后置返回通知，在目标方法成功执行后实施增强，可用于关闭流、删除临时文件等功能

- 后置(最终)通知，在目标方法执行后实施增强，与后置返回通知不同的是，不管谁否发生异常都要执行该类通知，
  该类通知可应用于释放资源

- 异常通知，在方法抛出异常后实施增强，可应用于处理异常、记录日志等功能

- 引入通知，在目标类中添加一些新的方法和属性，可应用于修改目标类

### ProxyFactoryBean

ProxyFactoryBean 是`org.springframework.beans.factory.FactoryBean`接口的实现类，
FactoryBean 负责实例化一个 Bean 实例，ProxyFactoryBean 负责为其他 Bean 实例创建代理实例

## 基于 XML 配置开发 AspectJ

AspectJ 是一个基于 Java 语言的 AOP 框架，使用 AspectJ 实现 Spring AOP 的方式有两种，一是基于
XML 配置开发 AspectJ，二是基于注解开发 AspectJ

基于注解开发 AspectJ 要比基于 XML 配置开发 AspectJ 便捷许多

- `@Aspect` 用于定义一个切面，注解在切面上

- `@Pointcut` 用于定义切入点表达式，在使用时需要定义一个切入点方法，该方法是一个返回值 void 且方法体为空的
  普通方法

- `@Before` 用于定义前置通知，在使用时通常为其指定 value 属性值，该值可以是已有的切入点，也可以直接定义切入点表达式

- `@AfterReturning` 用于定义后置返回通知

- `@Around` 用于定义环绕通知

- `@AfterThrowing` 用于定义异常通知

- `@After` 用于定义后置(最终)通知
