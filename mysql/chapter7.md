# 查询数据

数据库管理系统的一个最重要的功能就是数据查询，数据查询不应只是简单返回数据库中存储的数据，
还应该根据需要对数据进行筛选，以及确定数据库以什么样的格式显示。MySQL 提供了功能强大、灵活
的语句来实现这些操作，本章介绍使用`SELECT`语句查询数据库中的一列或多列数据、使用集合函数
显示查询结果、连接查询、子查询以及使用正则表达式进行查询等

## 单表查询

单表查询是指从一张表数据中查询所需的数据，本节介绍单表查询中的各种基本的查询方式，查询所有字段、
查询指定字段、查询指定记录、查询空值、多条件的查询、对插叙结果进行排序等

**在 SELECT 语句中指定字段**

SELECT 关键字后面的字段名为将要查找的数据，如果忘记了字段名称，可以使用`DESC`命令查看表的结构

```
DESC 表名;
```

### 查询指定记录

数据库中包含大量的数据，根据特殊要求，可能只需要查询表中的指定数据，即对数据进行过滤。在 SELECT 语句中，
通过`WHERE`子句可以对数据进行过滤

```
SELECT 字段名1,字段名2,...,字段n
FROM 表名
WHERE 查询条件;
```

### 带 IN 关键字的查询

IN 操作符用来查询满足指定范围内的条件的记录，使用 IN 操作符，将所有检索条件用括号括起来，检索条件之间
用逗号分隔开，只要满足条件范围内的一个值即为匹配项

相反的，可以使用关键字 NOT 来检索不在条件范围内的记录

### 带 BETWEEN AND 的范围查询

BETWEEN AND 用来查询某个范围内的值，该操作符需要两个参数，即范围的开始值和结束值

### 带 LINK 的字符匹配查询

如果要查找所有包含字符`ge`的水果名称，该如何查找呢？简单的比较操作在这里已经行不通了，
在这里需要使用通配符进行匹配查找，通过创建查找模式对表中的数据进行比较，执行这个任务的关键字是 LINK

通配符是一种在 SQL 的 WHERE 条件子句中拥有特殊意思的字符，SQL 语句中支持多种通配符，
可以和 LINK 一起使用的通配符有`%`和`_`

- `%` 匹配任意长度的字符，甚至包括零字符。在搜索匹配时通配符`%`可以放在不同位置

- 下划线通配符`_`，一次只能匹配任意一个字符

### 查询空值

数据表创建的时候，设计者可以指定某列中是否可以包含空值(NULL)，空值不同于 0，也不同于空字符串。
空值一般表示数据未知、不适用或将在以后添加数据。在 SELECT 语句中使用 IS NULL 子句，可以查询
某字段内容为空记录

```sql
SELECT c_id, c_name, c_email FROM customers WHERE c_email IS NULL;
```

与 IS NULL 相反的是 NOT IS NUL，该关键字查找字段不为空的记录

### 带 AND 的多条件查询

使用 SELECT 查询时，可以增加查询的限制条件，这样可以使查询的结果更加精确。MySQL 在 WHERE 子句
中使用 AND 操作符限定只有满足所有查询条件记录才会被返回。可以使用 AND 连接两个甚至多个查询条件，
多个条件表达式之间用 AND 分开

### 带 OR 的多条件查询

与 AND 不同，在 WHERE 声明中使用 OR 操作符，表示只需要满足其中一个条件的记录即可返回。
OR 也可以连接两个甚至多个查询条件，多个表达式之间用 OR 分开

> OR 可以和 AND 一起使用，但是在使用时要注意两者的优先级，由于 AND 的优先级高于 OR，
> 因此先对 AND 两边的操作数进行操作，再与 OR 中的操作数结合

### 查询结果不重复

出于对数据分析的需求，需要消除重复的记录值，如何使查询结果没有重复呢？在 SELECT 语句中，
可以使用`DISTINCT`关键字指示 MySQL 消除重复的记录值

```sql
SELECT DISTINCT 字段名 FROM 表名;
```

### 对查询结果排序

从查询结果看，字段的值是没有任何顺序的，MySQL 可以通过在 SELECT 语句中使用 ORDER BY 子句，
对查询结果进行排序

有时，需要根据多列值进行排序，对多列数据进行排序，需要排序的列之间用逗号隔开

> 在对多列进行排序的时候，首先排序的第一列必须有相同的值，才会对第二列进行排序，如果第一列中所有
> 值都是唯一的，将不再对第二列进行排序

### 指定排序方向

默认情况下，查询数据字母升序进行排序从`A~Z`，但数据的排序并不仅限于此，还可以使用 ORDER BY 对
查询结果进行降序排序`Z～A`，这可以通过关键字 DESC 实现

### 分组查询

分组查询是对数据按照某个或多个字段进行分组，MySQL 中使用 GROUP BY 关键字对数据进行分组

- 创建分组

GROUP BY 关键字通常和集合函数一起使用，如`MAX()`、`MIN()`、`COUNT()`、`SUM()`、`AVG()`。
例如要返回每个水果供应商的水果种类，这时就要在分组过程中用到`COUNT()`函数，把数据分为多个逻辑组，
并对每个组进行集合计算

```sql
SELECT s_id, COUNT(*) AS Total FROM fruits GROUP BY s_id;
```

要查看每个供应商的水果的种类的名称，将每个供应商的水果名称显示出来

```sql
SELECT s_id, GROUP_CONCAT(f_name) AS Names FROM fruits GROUP BY s_id;
```

- 使用 HAVING 过滤分组

GROUP BY 可以和 HAVING 一起限定显示记录所需满足的条件，只有满足条件的分组才会被显示

```sql
SELECT s_id, GROUP_CONCAT(f_name) AS Names
FROM fruits
GROUP BY s_id HAVING COUNT(f_name) > 1;
```

> HAVING 关键字和 WHERE 关键字都是用来过滤数据，两者有什么区别呢？其中重要的一点是，
> HAVING 在数据分组之后进行过滤来选择分组，而 WHERE 在分组之前用来选择记录，另外 WHERE 排除
> 的记录不再包括在分组中

- 在 GROUP BY 子句中使用 WITH ROLLUP

使用 WITH ROLLUP 关键字之后，在所有查询出的分组记录之后增加一条记录，该记录计算查询出的所有记录的总和，
即统计记数量

```sql
SELECT s_id, COUNT(*) AS Total
FROM fruits
GROUP BY s_id WITH ROLLUP;
```

- 使用 GROUP BY 可以对多个字段进行分组，GROUP BY 关键字后面跟需要分组的字段，MySQL 根据多字段
  的值来进行层次分组，分组层次从左到右，即先按第 1 个字段分组，然后在第 1 个字段值相同的记录中，再根据
  第 2 个字段的值进行分组，依次类推

```sql
SELECT s_id, f_name FROM fruits GROUP BY s_id, f_name;
```

- GROUP BY 和 ORDER BY 一起使用

某些情况下需要对分组进行排序，ORDER BY 用来对查询的记录排序，如果和 GROUP BY 一起使用可以完成对分组
的排序

> 当使用 ROLLUP 时，不能同时使用 ORDER BY 子句进行结果排序，即 ROLLUP 和 ORDER BY 是相互排斥的

### 使用 LIMIT 限制查询结果的数量

SELECT 返回所有匹配的行，如果仅仅需要返回前几行，使用 LIMIT 关键字

```
LIMIT [位置偏移量,] 行数
```

位置偏移量参数指示 MySQL 从哪一行开始显示，是一个可选参数，如果不指定位置偏移量，将会从表中的第一条
记录开始，第一条记录的偏移量是 0，第二条记录的位置偏移量是 1，依次类推
行数指返回的记录数

### 使用集合函数查询

有时候并不需返回实际表中的数据，而只是对数据进行总结，MySQL 提供一些查询功能可以对获取的数据进行分析和报告。

- `COUNT()` 函数统计数据表中包含的记录行的总数，或者根据查询结果返回列中包含的数据行数
  `COUNT(*)`计算表中总的行数，不管某列有数值或者为空值
  `COUNT(字段名)` 计算指定列下总的行数，计算时将忽略空值的行

- `SUM()` 是一个求总和的函数，返回指定列值的总和

```sql
SELECT SUM(quantity) AS items_total
FROM orderitems
WHERE o_num = 30005;
```

SUM()可以与 GROUP BY 一起使用，来计算每个分组的总和。SUN 函数在计算时，忽略列值为 NULL 的行

- `AVG()` 函数通过计算返回的行数和每一行数据的和，求得指定列数据的平均值

```sql
SELECT AVG(f_price) AS avg_price
FROM fruits
WHERE s_id = 102;
```

- `MAX()` 返回指定列中的最大值

```sql
SELECT MAX(f_price) AS max_price FROM fruits;
```

> MAX()函数除了用来找出最大的列值或日期值之外，还可以返回任意列中的最大值，包括字符类型的最大值
> MIN() 同样如此

- `MIN()` 返回查询中列的最小值

## 连接查询

连接是关系数据库模型的主要特点，连接查询是关系数据库中最主要的查询，主要包括内连接、外连接等。通过连接运算
符可以实现多个表查询。在关系数据库管理系统中，表建立时各数据之间的关系不必确定，通常把一个实体的所有信息
存放在一个表中，当查询数据时，通过连接操作查询出存放在多个表中的不同实体信息。当两个或多个表中存在相同
意义的字段时，便可以通过这些字段对不同的表进行连接查询

### 内连接查询

内连接(INNER JOIN)使用比较运算符进行表间某些列数据的比较操作，并列出这些表中与连接条件相匹配的数据行，组合成
新的记录，也就是说，在内连接查询中，只有满足条件的记录才能出现在结果关系中

```sql
SELECT suppliers.s_id, s_name, f_name, f_price
FROM fruits INNER JOIN suppliers
ON fruits.s_id = suppliers.s_id;
```

### 外连接查询

连接查询将查询多个表中的相关联的行，内连接时，返回查询结果集合中的仅是符合查询条件和连接条件的行。
但有时候需要包含没有关联的行中的数据，即返回查询结果集合中不仅包含符合连接条件的行，而且还包括左表、
右表或两边表中的所有数据行。
外连接分为左外连接和右外连接

- LEFT JOIN 左连接

左连接的结果包括`LEFT OUTER`子句中指定的左表的所有行，而不仅仅是连接列所匹配的行。如果左表的某行在右表中
没有匹配行，则在相关联的结果行中，右表的所有选择列表列均为空值

在 customers 表和 orders 表中，查询所有客户，包括没有订单的客户

```sql
SELECT customers.c_id, orders.o_num
FROM customers LEFT OUTER JOIN orders
ON customers.c_id = orders.c_id;
```

- RIGHT JOIN 右连接

右连接是左连接的反向连接，将返回右表的所有行，如果右表的某行在左表中没有匹配行，左表将返回空值

在 customers 表和 orders 表中，查询所有订单，包括没有客户的订单

```sql
SELECT customers.c_id, orders.o_num
FROM customers RIGHT OUTER JOIN orders
ON customers.c_id = orders.o_num;
```

### 复合条件连接查询

复合条件连接查询是在连接查询的过程中，通过添加过滤条件，限制查询的结果，使查询的结果更加准确

```sql
SELECT customers.c_id, orders.o_num
FROM customers INNER JOIN orders
ON customers.c_id = orders.c_id AND customers.c_id = 10001;
```

## 子查询

子查询指一个查询语句嵌套在另一个查询语句内部的查询，这个特性从 MySQL4.1 开始引入，在 SELECT 子句
中先计算子查询，子查询结果作为外层另一查询的过滤条件，查询可以基于一个表或多个表。
子查询中常用的操作符有 ANY、SOME、ALL、IN、EXISTS，子查询可以添加到 SELECT、UPDATE、DELETE 语句中，
而且可以进行多层嵌套，子查询也可以使用比较运算符如`<`、`<=`、`>`、`>=`、`!=`等

- 带 ANY、SOME 关键字的子查询

ANY 和 SOME 关键字时同义词，表示满足其中任一条件，它们允许创建一个表达式对子查询的返回值列表进行比较，只要
满足内层子查询中的任何一个比较条件，就返回一个结果作为外层查询的条件

- 带 ALL 关键字的子查询

ALL 关键字与 ANY 和 SOME 不同，使用 ALL 时需要同时满足所有内层查询的条件

- 带 EXISTS 关键字的子查询

EXISTS 关键字后面的参数是一个任意的子查询，系统对子查询进行运算以判断它是否返回行，如果至少返回一行，那么 EXISTS 的
结果为 true，此时外层查询语句进行查询；如果子查询没有返回任何行，那么 EXISTS 返回的结果是 fals，此时外层
语句将不进行查询

- 带 IN 关键字的子查询

IN 关键字进行子查询时，内层查询语句仅仅返回一个数据列，这个数据列里的值将提供给外层查询语句
进行比较操作

> 子查询的功能也可以通过连接查询完成，但是子查询使得 MySQL 代码更容易阅读和编写

```sql
SELECT c_id FROM orders WHERE o_num IN
(SELECT o_num FROM orderitems WHERE f_id = 'c0');
```

## 合并查询结果

利用 UNION 关键字，可以给出多条 SELECT 语句，并将它们的结果组合成单个结果集。合并时两个表
对应的列数和数据类型必须相同。各个 SELECT 语句之间使用 UNION 和 UNION ALL 关键字分隔。
UNION 不使用关键字 ALL，执行的时候删除重复的记录，所有返回的行都是唯一的，使用关键字
ALL 的作用是不删除重复行也不对结果进行自动排序

```sql
SELECT column... FROM table1
UNION [ALL]
SELECT column... FROM table2
```

## 为表和字段取别名

当表名字很长或者执行一些特殊查询时，为了方便操作或者需要多次使用相同的表时，可以为表指定别名，
用这个别名替代表原来的名称

```
表名 [AS] 表别名
```

示例

```sql
SELECT c.c_id, o.o_num
FROM customers AS c LEFT OUTER JOIN orders AS o
ON c.c_id = o.c_id;
```

MySQL 可以同时为多个表取别名，而且表别名可以放在不同的位置，如 WHERE 子句、SELECT 列表、
ON 子句以及 ORDER BY 子句等

> 在为表取别名时，要保证不能与数据库中的其他表的名称冲突

- 为字段取别名

在有些情况下，显示的列名称会很长或者名称不够直观，MySQL 可以指定列别名，替换字段或表达式

```
列名 [AS] 列别名
```

## 使用正则表达式查询

正则表达式通常被用来检索或替换哪些符合某个模式的文本内容，根据指定的匹配模式匹配文本中符合
要求的特殊字符串。
例如从一个文本文件中提取电话号码，查找一篇文章中重复的单词或者替换用户输入的某些敏感词语等，
这些地方都可以使用正则表达式，正则表达式强大而且灵活，可以应用于非常复杂的查询

- 查询以特定字符或字符串开头的记录

查询 f_name 字段以字母`b`开头的记录

```sql
SELECT * FROM fruits WHERE f_name REGEXP '^b';
```

- 查询以特定字符或字符串结尾的记录

```sql
SELECT * FROM fruits WHERE f_name REGEXP 'y$';
```

- 用符号`.`来替代字符串中的任意一个字符

```sql
SELECT * FROM fruits WHERE f_name REGEXP 'a.g';
```

- 使用`*`和`+`来匹配多个字符

- 配置指定字符串

```sql
SELECT * FROM fruits WHERE f_name REGEXP 'on';
```

- 匹配指定字符中的任意一个

```sql
SELECT * FROM fruits WHERE f_name REGEXP '[ot]';
```

- 匹配指定字符以外的字符，`[^字符集合]` 匹配不在指定集合中的任何字符

- 使用`{n,}` 表示至少匹配 n 次前面的字符，`字符串{n,m}`表示匹配前面的字符串不少于 n 次，
  不多于 m 次

## 问题详解

- 什么时候使用引号

在查询的时候，会看到在 WHERE 子句中使用条件，有的值加上了单引号，而有的值未加。单引号用来限定字符串，
如果将值与字符串类型列进行比较，则需要限定引号，而用来与数值进行比较则不需要用引号

- 为什么使用通配符格式正确，却没有查找出符合条件的记录

MySQL 中存储字符串数据时，可能会不小心把两端带有空格的字符串保存到记录中，而在查看表中的记录时，MySQL 不能
明确的显示空格，数据可操作者不能直观的确定字符串两端是否有空格

例如使用`%e`匹配以字母 e 结尾的水果的名称，如果字母 e 后面多了一个空格，则 LIKE 语句不能将该记录查找出来。
解决方法是使用`TRIM`函数，将字符串两端的空格删除之后再进行匹配
