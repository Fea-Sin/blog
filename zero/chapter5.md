# 计算机体系结构

## 存储程序

跟许多科学上的突破一样，存储程序概念的基本思想其实相当简单，计算机基于固定的硬件平台，能够执行固定的指令集，
同时，这些指令能够被当成构件模块，组成任意的程序

不同于 1930 年以前的机械术算计，这些程序的逻辑并没有被嵌入到硬件中，而是被存储到计算机的存储设备里，跟数据一样，
成为所谓的软件，因为计算机的操作是通过当前正在执行的软件来向用户展示其功能，所以每次向计算机中载入不同的程序时，同样的
硬件平台可以实现完全不同的功能

## 冯·诺依曼结构

存储程序概念是很多抽象的、应用型计算机模型的关键，其中最著名的是通用图灵机和冯·诺依曼机

图灵机是描述虚拟的简单计算机的抽象机，主要用来分析计算机系统的逻辑基础
冯·诺依曼机是实际应用型的体系结构，它几乎是今天所有计算机平台的基础

冯·诺依曼体系结构的基础是一个中央处理单元，它与记忆设备(内存)进行交互，负责从输入设备接收数据，向输出设备发送数据。
这个体系结构的核心是存储程序的概念：计算机内存不仅存储着要进行操作的数据，还存储着指示计算机运行的指令

## 内存

冯·诺依曼机的内存中存有两种类型的信息，数据项和程序指令，对这两种信息通常采用不同的方式来处理，在某些计算机里，
它们被分别存储到不同的内存区中，尽管它们具有不同的功能，但两种信息都以二进制数字形式存储在具有通用结构的随机存储器中
(一个连续的固定宽度的单元阵列或存储单元，每个单元都有一个独立的地址)表示，一个独立的字(代表一个数据或者一条指令)通过
它的地址来指定

## 数据内存

高级程序操纵抽象的元件，例如变量、数组和对象，这些数据抽象被翻译成机器语言后，就变成一连串的二进制数，存储在计算机的数据
内存中。一旦通过指定的地址，在数据内存中找到对应的内存单元，就可以对该内存单元进行读操作或写操作

## 指令内存

当高级命令被翻译成机器语言时，它变成一系列的二进制字，这些字代表机器的指令。这些指令被存储在计算机的指令内存中，在计算机的每一步
CPU 从指令中取出一个字，对其进行解码，从而执行指定的指令，然后计算下一条要执行的指令

## 中央处理器

CPU 是计算机体系的核心，负责执行已被加载到指令内存中的指令。这些指令告诉 CPU 去执行不同的计算，对内存
进行读/写操作，以及根据条件跳转去执行程序中其他指令。CPU 通过使用三个主要的硬件要素来执行这些任务：算术逻辑单元，
一组寄存器和控制单元

**算术逻辑单元**

ALU 负责执行计算机中所有底层的算计操作和逻辑操作

**寄存器**

CPU 的设计是为了能够快速地执行简单计算，为了体高它的性能，将这些和运算相关的数据暂存到某个局部存储器中是
十分必要的，这远比从内存中搬进搬出要好。因此，CPU 都配有一组高速寄存器，每个寄存器都能保存一个单独的字

**控制单元**

计算机指令用二进制代码来表示，通常具有 16、32、64 位宽。在指令能够执行之前，须对其进行解码，指令里面包含的信息
向不同的硬件设备(ALU、寄存器、内存)发送信息，指使它们如何执行指令，指令的解码过程是通过某些控制单元完成，这些控制
单元还负责决定下一步需要取出和执行哪一条指令

CPU 操作现在可以被描述成一个重复的循环，从内存中取一条指令，将其解码，执行该指令，取下一条指令，如此反复循环。
指令的执行过程可能包含下面的一些子任务，让 ALU 计算一些值，控制寄存器，从存储设备中读取一个字，或向存储设备中
写入一个字，在执行这些任务的过程中，CPU 也会计算出一下步该读取并执行哪一条指令

## 寄存器

内存访问是很慢的过程，当 CPU 被指示去取内存中地址 j 的内容，下面的一些过程会发生

- j 从 CPU 传到 RAM

- RAM 的直接访问逻辑选中地址为 j 的寄存器

- RAM[j] 的内容传回到 CPU

寄存器位于 CPU 芯片内部，所以对它们的访问几乎可以瞬间完成。寄存器数量非常少，因此机器语言指令使用短短的几个
位就能指定要操作的寄存器

基于不同的目的，不同的 CPU 采用不同数量、不同类型的寄存器，在一些计算机体系结构中，每个寄存器可以有多种用途

## 数据寄存器

这些寄存器为 CPU 提供短期记忆(memory)服务，当计算 `(a-b).c` 时，必须首先计算`(a-b)`的值比并记住它，虽然这个结果
可以暂时地被存储到存储单元中，但更好的办法是存储在 CPU 内部即数据寄存器

## 寻址寄存器

为了进行读写，CPU 必须连续访问内存中的数据，这样我们必须确定被访问的内存字所在的内存地址。在某些情况下这个地址
作为当前指令的一个部分给出，而其他某些情况下它依赖于前面一条指令的执行结果，对于后者这个地址应该被存储到某个寄存器中

## 程序计数寄存器

执行程序时，CPU 必须总是知道下一条指令在指令内存中的地址，这个地址保存在一个特殊的寄存器即程序计数寄存器中。在执行当前
指令过程中，CPU 通过两种方式之一来更改程序计数寄存器的内容

如果指令不包括跳转命令，程序计数寄存器增 1 以便使指针指向程序中的下一条指令

如果当前指令中包含需要执行的`goto n` 命令，则 CPU 将程序计数寄存器置为`n`

## 输入和输出

计算机使用一组输入输出(I/O)设备来与外部环境进行交互，这些设备包括屏幕、键盘、鼠标、扫描仪，网络接口卡、光驱等，
还有一些复杂的集成在汽车、武器系统、医疗器械等机器中的嵌入式计算机。计算机科学家设计不同的方案将这些不同外设的物理
细节封装起来，让计算机能以相同的方式对它们进行操作

处理外设基本的技术是 I/O 映像，I/O 映像的基本思想是，每个 I/O 设备在内存中都分配了独立的区域。对于输入设备(键盘、鼠标)
等，内存映像能连续不断的反映设备的物理状态，对于输出设备(屏幕、扬声器)等，内存映像连续地驱动设备的物理状态。当外部事件作用于
输入设备时，某些特定的值被写入它们各自对应的内存映像中，同样地想控制某些输出设备，就将一些特定值写入各自对应的内存映像

从硬件的角度来看，这个方案需要所有 I/O 设备提供类似于记忆单元的那种接口，从软件的角度来看，需要对每个 I/O 设备定义交互协议

CPU 以及整个平台的设计可以完全不依赖于要与计算机进行交互的 I/O 设备，也不依赖于 I/O 设备的数量和种类。无论何时将新的 I/O
设备于计算机连接，所要做的只是为其分配一个新的内存映像并记录它的基地址，这些配置工作是由操作系统来完成

## Hack 硬件平台

Hack 平台是 16 位冯·诺依曼机，包括一个 CPU、两个独立的内存模块(指令内存和数据内存)和两个内存 I/O 设备(屏幕和键盘)

数据内存用 RAM 表示，指令内存用 ROM 表示

Hack 的 CPU 由 ALU 和三个分别称为 数据寄存器(D)、地址寄存器(A)和程序计数寄存器组成

D 和 A 是通用的 16 位寄存器，D 寄存器仅仅用来存储数据值，而 A 寄存器可以被解释为数据值、RAM 地址或 ROM 地址

`取指令-执行`循环意味着在 Hack 平台里，对 RAM 单元的读/写操作或是到 ROM 的跳转操作

## 中央处理器

Hack 平台的 CPU 被设计用来执行 16-位指令，它与两个相互独立的内存模块相连。一个是指令内存，CPU 从该内存取指令，另一个
是数据内存，CPU 可以对其进行读/写数据

**CPU 架构**

指令解码 CPU 输入的 16 位指令可以代表一条 A-指令或者一条 C-指令

指令执行 指令的各个域 i-位域、a-位域、c-位域、d-位域、j-位域会被同时发送到 CPU 中的各个组件，这样各组件就会根据指令的内容
各自进行工作，协同执行指令

读取下一条指令 在执行当前指令的同时，CPU 还可以确定下一条指令的地址，通过程序计数器的输出端发送该地址，任务驱动器就是程序计数器

> 从发展历程看，为了加强处理器性能而付出的努力引出了两个主要的硬件设计派系
> 复杂指令计算机 方法的倡导者认为，为了取得更好的性能，提供丰富和详细的指令集
> 精简指令计算机 阵营为了尽可能的提升硬件速度，使用较简单的指令集
