# 高级语言

本书所介绍的硬件系统和软件系统都是底层系统，人们一般不会和它直接打交道，本章介绍一门高级语言 Jack

Jack 是简单的基于对象的语言，具有现代语言的基本特性和风格，但是语法相对简单，且不支持继承。尽管 Jack 很简单，
它仍然是一种通用语言

每个 Jack 程序必须至少包含一个名为`Main`的类，而且这个类必须包含一个名为 Main.main 的函数

Jack 语言内置了标准程序库，这个库通过不同的抽象和服务，比如数组、字符串、数学函数、内存管理、输入/输出等等
来扩展基本语言

```
class Main {
  function void main() {
    do Output.printString("Hello World");
    do Output.println();
    return;
  }
}
```

每种编程语言都有一组固定的基本数据类型，Jack 支持三种基本数据类型`int`, `char`, `boolean`。
程序员可以通过创建新的抽象数据类型对基本数据类型进行扩展

## 定义类的接口

合理的方法是，指定该分数抽象中的数据和服务

```
class Main {
  function void main() {
    var Array a;
    var int length;
    var int i, sum;

    let length = Keyboard.readInt("How many numbers?");
    let a = Array.new(length);
    let i = 0;

    while (i < length) {
      let a[i] = Keyboard.readInt("Enter the next number: ");
      let sum = sum + a[i];
      let i = i + 1
    }

    do Output.printString("The average is: ")
    do Output.printInt(sum / length);
    do Output.println();
    return;
  }
}
```

Jack 语言中，在当前对象的操作方法用`this`来表示，而类级别上的操作用函数来表示，创建新对象的操作称为构造函数

用户只能访问抽象的接口或 API，并将其看作提供`与抽象相关的操作`

经典的 Jack 程序结构： 类、方法、构造函数和函数

## 链表实现

链表是一种对象链，每个对象包含数据域和指向链表中另一个对象的指针

```
class List {
  field int data;
  field List next;

  constructor List new(int car, List cdr) {
    let data = car;
    let next = cdr;
    return this;
  }

  method void dispose() {
    if (~(next = null)) {
      do next.dispose()
    }

    do Memory.deAlloc(this)
    return;
  }

  // 更多和链表相关的方法
}
```

创建用来保存数字 2, 3, 5 的链表

```
function void create235() {
  var List v;
  let v = List.new(5, null);
  let v = List.new(2, List.new(3, v));

  do v.dispose();
  return;
}
```

## Jack 语言规范

现在来对 Jack 语言作正式完整的描述，包括语法要素、程序结构、变量、表达式和语句构成

Jack 程序是一系列用任意数量空格和注释而分割开来的字元(tokens)，这些字元可以是符号、保留字、常数和标识符

## 程序结构

Jack 中的基本编程单元是类，每个类存在于独立的文件中，可独立编译，类的定义具有如下格式

```
class 名称 {
  成员字段field和静态变量声明
  子程序声明
}
```

每个类声明先指定类的名称，通过该名称，对应的类可以在全局范围内被访问到。接下来是一组零个或多个成员字段(field)和
静态变量(static variable)声明。最后是一组一个或多个子程序声明，每个声明定义方法、函数或构造函数。

方法属于对象并且提供对象的功能，函数一般属于类，而且不与某个特定的对象相关(跟 Java 中的静态方法类似)，构造函数属于
类，被调用时生成该类的对象实例

**子程序的声明格式**

```
subroutine 类名 名称(参数列表) {
  局部变量声明
  语句
}
```

子程序可以是构造函数、方法和函数，每个子程序都有供调用的名称，以及描述该子程序返回值的类型。如果子程序
不返回任何值，则返回类型为 void，如果子程序有返回值，则返回类型可以是该语言所支持的任何基本类型，或者标准库提供的
类类型，或者应用中其他类提供的类类型。构造函数可以取任意名称，返回值必须返回该类的对象。因此，构造函数的返回类型
必然是它所属的类

Jack 程序也是由一个或多个类构成，必须有一个类被命名为 Main，该类至少必须包含名为 main 的函数。当执行 Jack 程序时，
Jack 运行期环境将自动地开始执行 Main.main 函数

## 变量

Jack 语言中的变量在使用之前必须先被显式地声明出来，在 Jack 中有四种类型的变量，成员字段、静态变量、局部变量和
参数变量，每种变量都有其适用范围

**数据类型**

变量可以是一种基本数据类型，或是对象类型，即类名称。实现这种数据类型的类可以是 Jack 标准库中的类，也可以是在程序路径
下的其他类

**基本数据类型**

- int， 16-位

- boolean，true 和 false

- char， Unicode 字符

当基本类型变量被声明时，就会在内存中为其分配对应的内存单元

**对象类型**

每个类定义了对象类型，跟 Java 一样，对象的声明实际只是创建一个指向该对象的引用变量，真正用于存储该对象的内存单元只
有在调用构造函数对象时才会被分配

**类型转换**

Jack 是弱类型语言，语言规范并没有定义从一种类型转为另一种类型的结果，允许和禁止某种转换是根据不同的编译器而定的，放开
这个自由度是有意为之，这样就能忽略类型问题，以便构建最小规模的 Jack 编译器

所有 Jack 编译器都期望能允许并且自动执行下面的任务

- 字符和整数能够根据 Unicode 规范在必要时相互转换

- 整数可被赋给任何对象类型的引用变量，这时该整数被当作是内存中的地址

- 对象变量可被转换成 Array 变量，反之亦然。经过转换就可以像访问数组中的数据项一样去访问对象中的成员

## 变量类型和作用域

Jack 有四种类型的变量。静态变量定义在类这一级，被该类的所有对象共享。比如，BankAccount 类可以定义
totalBalance 静态变量来保存所有银行账户的金额总数，其中每个账户都是 BankAccount 类的实例对象

**成员字段** 用于定义类对象的属性

**局部变量** 被子程序使用，仅仅存在于子程序的生命周期内

**参数变量** 用于传递变量给子程序

变量的作用域是程序中该变量可以被识别并发挥作用的范围

## 表达式

Jack 表达式必须是下列之一

- 常数

- 在作用域内的变量名，变量可以是静态、局部、参数

- 关键字 this，引用当前对象(不能用于函数中)

- 数组语法

- 返回值为非空类型的子程序调用

- 一元运算符`-`或`~`作为前缀的表达式
  `-表达式` 算术求反，`~表达式` 布尔求反

- 形如`表达式 运算符 表达式` 的表达式，其中运算符是以下二元运算符中的一种
  `+, -, *, /, &, |, >, <, =`

- 位于圆括号内的表达式

## 子程序调用

子程序调用唤起方法、函数、构造函数，使用这样的语法形式： `methodNanme(argumentlist)`

## 对象构造和清除

对象的构造可以分为两个阶段，在程序定义某个对象类型的变量之后，仅仅创建了引用(指针)并为其分配了内存。为了完成对象的
构造，程序必须调用该类的构造函数。因此，实现数据类型的类至少必须包含一个构造函数，构造函数可取任意名称，但习惯上使用
`new`来称呼它

```
let c = Circle.new(x, y, 50)

```

调用构造函数时，编译器会要求操作系统分配足够的内存空间，实际就是一块内存段，来存放新对象。操作系统会返回该内存段的
基地址，最后编译器将该地址赋予`this`指针(上面实例中 this 的值赋给 c)，接下来，对象被初始化，具体由构造函数中的
Jack 语句来完成

当程序中不再需要某个对象时，该对象就可以被清除。对象可以从内存中去分配空间，可以通过标准库中的`Memory.deAlloc(object)`函数
收回原先分配给对象的内存空间，按照惯例，每个类都要包含`dispose()`方法

## Jack 标准库

Jack 语言本身提供了一组内置类，扩展了语言能力，标准库也可被看作是基本的操作系统，必须提供给 Jack 语言实现

- Math 提供基本的数学运算

- String 实现字符串类型和字符串相关操作

- Array 实现数组类型和数组相关操作

- Output 处理屏幕上的文本输出

- Screen 处理屏幕上的图像输出

- Keyboard 处理键盘用户输入

- Memory 处理内存操作

- Sys 提供与程序执行相关的服务

## 应用程序的设计和实现

在设计流程中，首先要对应用程序的行为作为概念性描述，在图形和交互程序的情况下，该描述通常表现为屏幕画面的手绘图例

在一些简单应用中，设计者可以从过程化编程来开始逐步实现，在更复杂的应用中，建议首先为应用程序创建基于对象的设计方案。
者让我们能辨识出类、成员字段和子程序，进而得以创建一些 API

## Jack OS

Jack 程序会大量使用语言自身的标准库提供的各种抽象和服务，OS 本身也是用 Jack 语言编写的，因此其可执行版本也是一组编译后
的`.vm`文件，与编译之后的用户程序是类似的，因此，在运行任何 Jack 程序之前，首先必须将包含 Jack OS 的`.vm`文件拷贝到程序
路径下。

整个命令链条如下：
计算机首先运行`Sys.init`，该函数会自动运行`Main.main`函数，接着`Main.main`函数将从用户程序和 OS 中调用各种子程序和服务
