# 网络 IO 模型

IO 是计算机体系中重要的一部分，IO 类外设有打印机、键盘、复印机，存储类型的设备有硬盘、磁盘、U 盘等，
通信设备有网卡、路由器等。不同的 IO 设备有着不同的特点，数据率不一样，传动单位不一样、数据表示不一样

IO 有两种操作，同步 IO 和异步 IO，同步 IO 指的是必须等待 IO 操作完成后，控制权才返回给用户进程。
异步 IO 指的是，无须等待 IO 操作完成，就将控制权返回给用户进程

网络 IO，由于不同的 IO 设备有着不同的特点，网络通信中往往需要等待

- 输入操作，等待数据到达套接字接收缓冲区

- 输出操作，等待套接字发送缓冲区有足够的空间容纳将要发送的数据

- 服务器接收连接请求，等待新的客户端连接请求的到来

- 客户端发送连接请求，等待服务器回送客户的发起的 SYN 所对应的 ACK

当一个网络 IO 发生时，它会涉及两个系统，一个是调用这个 IO 的进程，另一个是系统内核
当一个 read 操作发生时，他会经历两个阶段，等待数据准备，将数据从内核拷贝到进程中

## 4 种网络 IO 模型

**阻塞 IO 模型**

大部分的 socket 接口都是阻塞型的，所谓阻塞型接口是指系统调用时却不返回调用结果，并让当前线程
一直处于阻塞状态，只有当该系统调用获得结果或者超时时才返回结果。实际上，除非特定指定，几乎所有的 IO 接口
(包括 socket 接口)都是阻塞型的。这给网络带来一个很大的问题，线程处于阻塞状态，线程将无法执行任何运算或
响应任何网络请求

一个简单的改进方案是在服务器端使用多线程(或多进程)，每个连接都拥有独立的线程或进程。进程的开销要远远大于线程，
所以需要同时为较多的客户端提供服务，则不推荐使用多进程。如果单个服务执行体要消耗较多的 CPU 资源，例如需要进行
大规模的运算或文件访问，则推荐使用较为安全的进程。
通常使用`pthread_create()`创建新线程，使用`fork()`创建新的进程

## 非阻塞 IO 模型

当用户进程发出 read 操作时，如果内核中的数据还没准备好，那么它并不会 block 用户进程，而是立刻返回一个错误，
它就知道数据还没准备好，于是它可以再次发送 read 操作
非阻塞的接口相比于阻塞型接口的显著差异在于被调用之后立即返回

## 多路 IO 复用模型

多路 IO 复用，有时也称为事件驱动 IO，它的基本原理就是有个函数会不断地轮询所有负责的所有 socket，当某个 socket 有
数据到达了，就通知用户进程

当用户进程调用了 select，那么整个进程会被阻塞，同时内核会`监视`所有的 select 负责的 socket，当任何一个 socket 中的
数据准备好了，select 就会返回。这个模型和阻塞 IO 的模型并没有太大的不同

## 异步 IO 模型

用户进程发起 read 操作之后，立刻就可以开始去做其他的事，而另一方面，从内核的角度，当它收到一个异步的 read 请求操作之后，
首先会立刻返回，所以不会对用户进程产生任何阻塞。然后内核会等待数据准备完成，然后将数据拷贝到用户内存中，当这一切都完成之后，
内核会给用户进程发送一个信号，返回 read 操作已完成的信息
